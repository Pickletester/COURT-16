<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Court 16 — TB1-SAFE (no time sync, ES5)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:transparent; font-family: Arial, Helvetica, sans-serif; }
    .bar{ position:fixed; left:0; right:0; bottom:0; height:72px; background:linear-gradient(90deg,#14203a,#22335d 70%); display:grid; grid-template-columns:1.2fr 2.2fr 1.1fr 2.1fr 1.2fr; gap:4px; padding:4px 6px; box-sizing:border-box; }
    .sec{ position:relative; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow:hidden; border-radius:6px; }
    .sec:not(#cn)::before{ content:""; position:absolute; left:3px; right:3px; top:3px; bottom:3px; background:#000; opacity:.78; border-radius:6px; }
    .label{ font-weight:700; text-transform:uppercase; font-size:10px; letter-spacing:.08em; z-index:1; margin-bottom:1px; }
    #cur .label{ color:#6cff6c;} #nxt .label{ color:#ffe56b;} #cd .label{ color:#d4e5fd;} #now .label{ color:#d4e5fd;}
    .val{ font-weight:800; z-index:1; text-align:center; line-height:1.08; color:#fff; padding:0 6px; }
    #cur .val, #nxt .val{ font-size:14px; white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
    #cd .val{ font-size:20px; }
    #now .val{ font-size:16px; }
    #cn .val{ font-size:58px; font-weight:900; padding:2px 12px; letter-spacing:.02em; border:2px solid #fff; border-radius:8px; text-shadow:0 1px 2px rgba(0,0,0,.4); }
    .meta{ font-size:10px; color:#d8d8d8; }
  </style>
</head>
<body>
  <div class="bar">
    <div id="cn" class="sec"><div class="val" id="cno">16</div></div>
    <div id="cur" class="sec"><div class="label">In Progress</div><div class="val" id="curv">Loading...</div></div>
    <div id="cd" class="sec"><div class="label" id="cdlbl">Time Left</div><div class="val" id="cdv">--</div></div>
    <div id="nxt" class="sec"><div class="label">Upcoming</div><div class="val" id="nxtv">Loading next...</div></div>
    <div id="now" class="sec"><div class="label">Current Time</div><div class="val" id="clock">--:--</div></div>
  </div>

<script>
(function(){
  // ======= CONFIG =======
  var COURT_NO = 16;
  var ORG_MEMBER_ID = "12674";
  var AUTH_B64 = "Basic T3JnXzEyNjc0OjEyNjc0XzE4NWFmZGE3LTdiNGYtNGIwYS04YmEwLWE3OWVhYzc4ODExZA==";
  var TZ = "America/New_York";

  // ======= UTIL =======
  function pad2(n){ return (n<10?"0":"")+n; }
  function toLocalNY(d){
    try{ return d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', hour12:true, timeZone: TZ}); }
    catch(e){ return d.getHours()+":"+pad2(d.getMinutes()); }
  }
  function todayStrNY(){
    try{ return new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); }
    catch(e){ var n=new Date(); return n.getFullYear()+"-"+pad2(n.getMonth()+1)+"-"+pad2(n.getDate()); }
  }
  function parseTimeAny(t){
    if(!t){return null;}
    if(Object.prototype.toString.call(t)==='[object Date]'){ return isNaN(t.getTime())?null:t; }
    if(typeof t==='number'){ return new Date(t>1e12?t:t*1000); }
    if(typeof t==='string'){
      var s=t.trim();
      var m=s.match(/^\/Date\((\d+)\)\/$/i); if(m){ return new Date(parseInt(m[1],10)); }
      var d=new Date(s); if(!isNaN(d.getTime())) return d;
    }
    return null;
  }
  function pickArray(c){
    if(!c){return [];}
    if(c instanceof Array){return c;}
    if(typeof c==='object'){
      if(c.Data && c.Data instanceof Array) return c.Data;
      if(c.data && c.data instanceof Array) return c.data;
      if(c.Items && c.Items instanceof Array) return c.Items;
      if(c.Results && c.Results instanceof Array) return c.Results;
    }
    return [];
  }
  function containsCourtN(rec, n){
    n = Number(n)||1;
    try{
      var txt = "";
      var fields = ["Courts","CourtName","ResourceName","Resources","Description","Notes","Title","EventName","Name"];
      for(var i=0;i<fields.length;i++){ var k=fields[i]; if(rec && rec[k]){ if(rec[k] instanceof Array){ txt += " " + rec[k].join(", "); } else txt += " " + String(rec[k]); } }
      txt = txt.toLowerCase();
      if(txt.indexOf("court #"+n) >= 0) return true;
      if(txt.indexOf("court "+n) >= 0) return true;
      if(txt.indexOf("courts "+n) >= 0) return true;
      var m, rg=/courts?\s+(\d+)\s*[-–]\s*(\d+)/g;
      while((m=rg.exec(txt))!==null){ var a=+m[1], b=+m[2]; if(n>=Math.min(a,b) && n<=Math.max(a,b)) return true; }
      return false;
    }catch(e){ return false; }
  }

  // ======= CLOCK =======
  function tickClock(){
    var el = document.getElementById('clock');
    el.textContent = toLocalNY(new Date());
    var now = new Date();
    var delay = 1000 - (now.getMilliseconds());
    if(delay < 250) delay = 250;
    setTimeout(tickClock, delay);
  }

  // ======= XHR =======
  function xhrJSON(url, headers, timeoutMs, cb){
    try{
      var x = new XMLHttpRequest();
      x.open("GET", url, true);
      x.timeout = timeoutMs||8000;
      if(headers){ for(var k in headers){ if(headers.hasOwnProperty(k)){ x.setRequestHeader(k, headers[k]); } } }
      x.onreadystatechange = function(){ if(x.readyState === 4){ if(x.status >= 200 && x.status < 300){ var data=null; try{ data=JSON.parse(x.responseText); }catch(e){ data=null; } cb(null, data); } else { cb(new Error("HTTP "+x.status)); } } };
      x.ontimeout = function(){ cb(new Error("timeout")); };
      x.onerror = function(){ cb(new Error("network")); };
      x.send();
    }catch(e){ cb(e); }
  }

  // ======= RENDER =======
  var cdTimer = null, cdMode = "none", cdTarget = null, nxtStart = null;
  function startCountdown(targetMs, mode){
    cdTarget = targetMs; cdMode = mode||"none";
    if(cdTimer){ clearTimeout(cdTimer); cdTimer = null; }
    function tick(){
      if(!cdTarget){ document.getElementById('cdv').textContent = '--'; return; }
      var diff = cdTarget - (new Date().getTime());
      var out = document.getElementById('cdv');
      if(diff > 0){
        var totalSec = Math.floor(diff/1000);
        var totalMin = Math.floor(diff/60000);
        if(diff <= 60000){ out.textContent = (totalSec%60)+'s'; }
        else if(totalMin >= 60){ out.textContent = Math.floor(totalMin/60)+'h '+(totalMin%60)+'m'; }
        else { out.textContent = totalMin+'m'; }
        cdTimer = setTimeout(tick, 1000);
      }else{
        if(cdMode === 'cur' && nxtStart){ cdMode = 'next'; cdTarget = nxtStart; document.getElementById('cdlbl').textContent='Time Until'; cdTimer=setTimeout(tick,1000); }
        else { out.textContent='--'; cdTarget=null; }
      }
    }
    tick();
  }

  function fmtTime(d){ return "<div class='meta'>"+toLocalNY(d.start)+" - "+toLocalNY(d.end)+"</div>"; }

  function render(cur, nxt){
    var curEl = document.getElementById('curv');
    var nxtEl = document.getElementById('nxtv');
    var cdLbl = document.getElementById('cdlbl');
    if(cur){
      curEl.innerHTML = cur.name + fmtTime(cur);
      cdLbl.textContent = 'Time Left';
      startCountdown(cur.end.getTime(), 'cur');
    }else{
      curEl.textContent = 'No current event';
      if(nxt){ cdLbl.textContent = 'Time Until'; startCountdown(nxt.start.getTime(), 'next'); }
      else { cdLbl.textContent = 'Time Left'; startCountdown(null, 'none'); }
    }
    if(nxt){ nxtEl.innerHTML = nxt.name + fmtTime(nxt); } else { nxtEl.textContent = 'No upcoming event'; }
  }

  // ======= DATA =======
  var lastGood = null;

  function buildDayUrls(){
    var d = todayStrNY();
    var ev = "https://api.courtreserve.com/api/v1/eventcalendar/eventlist?orgMemberId="+encodeURIComponent(ORG_MEMBER_ID)+"&startDate="+d+"T00:00:00&endDate="+d+"T23:59:59";
    var res = "https://api.courtreserve.com/api/v1/reservationreport/listactive?orgMemberId="+encodeURIComponent(ORG_MEMBER_ID)+"&reservationsFromDate="+d+"T00:00:00&reservationsToDate="+d+"T23:59:59&includePlayers=true";
    return {ev:ev, res:res};
  }

  function normalizeEvent(x){
    var nm = (x.EventName||x.Name||x.Title||"Event");
    var s = parseTimeAny(x.StartDateTime||x.StartTime||x.Start);
    var e = parseTimeAny(x.EndDateTime||x.EndTime||x.End);
    return (s && e) ? {name:nm, start:s, end:e, raw:x} : null;
  }

  function shortName(p){
    var fn = (p.FirstName||"").trim();
    var ln = (p.LastName||"").trim();
    var init = fn ? (fn.charAt(0).toUpperCase()+".") : "";
    return (init && ln) ? (init+" "+ln) : (init || ln || "");
  }

  function normalizeResv(x){
    var s = parseTimeAny(x.StartTime||x.StartDateTime||x.Start);
    var e = parseTimeAny(x.EndTime||x.EndDateTime||x.End);
    if(!s || !e) return null;
    var name = "";
    if(x.Players && x.Players instanceof Array && x.Players.length){
      var arr = [];
      for(var i=0;i<x.Players.length;i++){ arr.push(shortName(x.Players[i]||{})); }
      name = arr.join(", ");
    }
    if(!name && x.ReservationTypeName) name = x.ReservationTypeName;
    if(!name) name = "Reserved";
    return {name:name, start:s, end:e, raw:x};
  }

  var toggle = 0, cacheEv = [], cacheRes = [], cacheDate = "";

  function refresh(){
    var urls = buildDayUrls();
    var dstr = todayStrNY();
    if(cacheDate !== dstr){ cacheEv=[]; cacheRes=[]; cacheDate=dstr; toggle=0; }

    if(toggle === 0){
      xhrJSON(urls.ev, {"Authorization":AUTH_B64}, 8000, function(errE, dataE){
        if(!errE){ cacheEv = pickArray(dataE); }
        xhrJSON(urls.res, {"Authorization":AUTH_B64}, 8000, function(errR, dataR){
          if(!errR){ cacheRes = pickArray(dataR); }
          toggle = 1;
          computeAndRender();
        });
      });
    }else if((toggle % 2) === 1){
      xhrJSON(urls.ev, {"Authorization":AUTH_B64}, 8000, function(errE, dataE){
        if(!errE){ cacheEv = pickArray(dataE); }
        toggle++;
        computeAndRender();
      });
    }else{
      xhrJSON(urls.res, {"Authorization":AUTH_B64}, 8000, function(errR, dataR){
        if(!errR){ cacheRes = pickArray(dataR); }
        toggle++;
        computeAndRender();
      });
    }
  }

  function computeAndRender(){
    var ev = []; var i;
    for(i=0;i<cacheEv.length;i++){ var a=normalizeEvent(cacheEv[i]); if(a){ ev.push(a); } }
    var rs = [];
    for(i=0;i<cacheRes.length;i++){ var b=normalizeResv(cacheRes[i]); if(b){ rs.push(b); } }
    var evC = []; for(i=0;i<ev.length;i++){ if(containsCourtN(ev[i].raw, COURT_NO)) evC.push(ev[i]); }
    var rsC = []; for(i=0;i<rs.length;i++){ if(containsCourtN(rs[i].raw, COURT_NO)) rsC.push(rs[i]); }
    var all = rsC.concat(evC);
    all.sort(function(a,b){ return a.start - b.start; });
    var now = new Date();
    var cur = null, nxt = null;
    for(i=0;i<all.length;i++){ var it = all[i]; if(!cur && now >= it.start && now <= it.end){ cur = it; } if(!nxt && now < it.start){ nxt = it; } }
    nxtStart = nxt ? nxt.start.getTime() : null;
    if(cur || nxt){ lastGood = {cur:cur, nxt:nxt}; }
    if(cur || nxt){ render(cur, nxt); }
    else if(lastGood){ render(lastGood.cur, lastGood.nxt); }
    else{ render(null, null); }
  }

  document.getElementById('cno').textContent = String(COURT_NO);
  tickClock();
  refresh();
  setInterval(refresh, 30000);
})();
</script>
</body>
</html>
