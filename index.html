<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Court Display — 16 (HYBRID • SMART • Reliable • AlwaysConnected)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:transparent; font-family: Arial, Helvetica, sans-serif; }
    :root { --bar-height: 72px; --pulse-dur: 900ms; --pulse-min: .12; --pulse-max: .45; --pulse-border: 3px; --global-min:.05; --global-max:.18; }
    .graphic-bar{ position:fixed; left:0; right:0; bottom:0; height:var(--bar-height); background:linear-gradient(90deg,#14203a,#22335d 70%); display:grid; grid-template-columns:1.3fr 2.2fr 1.1fr 2.1fr 1.3fr; gap:4px; padding:4px 6px; box-sizing:border-box; z-index:1000; }
    .section{ position:relative; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow:hidden; border-radius:6px; isolation:isolate; }
    .section .compat-bg{ position:absolute; left:3px; right:3px; top:3px; bottom:3px; background:#000; opacity:.78; border-radius:6px; z-index:0; pointer-events:none; }
    #court-number .compat-bg{ display:none !important; }
    .label{ font-weight:700; text-transform:uppercase; font-size:10px; letter-spacing:.08em; z-index:2; margin-bottom:1px; }
    #current-event .label{ color:#6cff6c;} #next-event .label{ color:#ffe56b;} #countdown .label{ color:#d4e5fd;} #current-time .label{ color:#d4e5fd;}
    .meta{ font-size:10px; color:#d8d8d8; opacity:.9; line-height:1.05; }
    .value{ font-weight:800; z-index:2; text-align:center; line-height:1.05; color:#fff; padding:0 4px; }
    #current-event .value,#next-event .value{ font-size:14px; max-height:none!important; overflow:visible!important; white-space:normal; overflow-wrap:anywhere; word-break:break-word; padding:0 6px 3px; align-self:center; }
    #countdown .value{ font-size:20px;} #current-time .value{ font-size:16px;}
    #court-number{ display:flex; align-items:center; justify-content:center;}
    #court-number .value{ font-size:58px; font-weight:900; padding:2px 12px; letter-spacing:.02em; border:2px solid #fff; border-radius:8px; text-shadow:0 1px 2px rgba(0,0,0,.4); background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.03)); color:#fff; line-height:1; }
    #countdown .cdFill,#countdown .cdBorder{ position:absolute; left:2px; right:2px; top:2px; bottom:2px; border-radius:6px; pointer-events:none; z-index:1; display:none; transform-origin:center center; }
    #countdown.under-minute .cdFill{ display:block; background:#ff0000; animation:pulseSmooth var(--pulse-dur) ease-in-out infinite; }
    #countdown.under-minute .cdBorder{ display:block; border:var(--pulse-border) solid rgba(255,0,0,var(--pulse-min)); animation:borderSmooth var(--pulse-dur) ease-in-out infinite; }
    @keyframes pulseSmooth{0%{opacity:var(--pulse-min);transform:scale(1)}50%{opacity:var(--pulse-max);transform:scale(1.03)}100%{opacity:var(--pulse-min);transform:scale(1)}}
    @keyframes borderSmooth{0%{opacity:var(--pulse-min)}50%{opacity:var(--pulse-max)}100%{opacity:var(--pulse-min)}}
    #globalPulse{ position:fixed; left:0; top:0; right:0; bottom:0; background:#ff0000; opacity:0; pointer-events:none; display:none; z-index:99999; }
    body.global-under-minute #globalPulse{ display:block; animation:globalSmooth var(--pulse-dur) ease-in-out infinite; }
    @keyframes globalSmooth{0%{opacity:var(--global-min)}50%{opacity:var(--global-max)}100%{opacity:var(--global-min)}}
    body.global-under-minute #globalPulse, body.global-under-minute #countdown .cdFill, body.global-under-minute #countdown .cdBorder{ animation-delay:var(--pulse-phase,0ms); }
    body.wait-net #clock::after{ content:""; } body.wait-net #clock{ color:#fff; }
    body.local-fallback #clock::after{ content:""; } body.local-fallback #clock{ color:#fff; }
    body.offline .graphic-bar{ background:linear-gradient(90deg,#1a1f33,#2a3458 70%); }
    body.offline #current-event .value, body.offline #next-event .value, body.offline #countdown .value, body.offline #current-time .value{ opacity:1!important; color:#fff!important; }
    body.offline #countdown .cdFill, body.offline #countdown .cdBorder, body.offline #globalPulse{ display:none!important; }
  </style>
</head>
<body class="wait-net">
  <div class="graphic-bar" id="bar">
    <div id="court-number" class="section"><div class="value" id="court-val">16</div></div>
    <div id="current-event" class="section"><div class="compat-bg"></div><div class="label" id="cur-label">In Progress</div><div class="value" id="cur-val">Loading...</div></div>
    <div id="countdown" class="section"><div class="compat-bg"></div><div class="label" id="cd-label">Time Left</div><div class="value" id="cd-val">--</div><div class="cdFill"></div><div class="cdBorder"></div></div>
    <div id="next-event" class="section"><div class="compat-bg"></div><div class="label">Upcoming</div><div class="value" id="next-val">Loading next...</div></div>
    <div id="current-time" class="section"><div class="compat-bg"></div><div class="label">Current Time</div><div class="value" id="clock">--:--</div></div>
  </div>
  <div id="globalPulse"></div>

  <script>
    /* ===== Connectivity constants ===== */
    const KEEPALIVE_URL = 'https://www.gstatic.com/generate_204';  // ultra-light ping (no-cors)
    const KEEPALIVE_MS  = 25000;   // keep Wi‑Fi/NAT warm
    const WATCHDOG_MS   = 45000;   // if no successful API hit within this window, force resync

    /* ===== Net time + general config ===== */
    let NET_LOCKED=false, NET_BASE_MS=0, NET_BASE_T=0, lastNetOKPerf=0;
    const OFFLINE_AFTER_MS=15000, NET_GRACE_MS=8000, PHASE_MS=700, BURST_WINDOW_MS=120000, BURST_INTERVAL_MS=2000, RESYNC_MS=5000;
    let startPerf=performance.now();
    let COURT_NO=16;
    const AUTH_B64="Basic T3JnXzEyNjc0OjEyNjc0XzE4NWFmZGE3LTdiNGYtNGIwYS04YmEwLWE3OWVhYzc4ODExZA==";
    const ORG_MEMBER_ID="12674";

    function parseHttpDate(s){ const t=Date.parse(s); return isNaN(t)?null:t; }
    function nowMs(){ return NET_LOCKED ? (NET_BASE_MS+(performance.now()-NET_BASE_T)) : Date.now(); }
    function setPulsePhase(){ const phase=nowMs()%PHASE_MS; document.documentElement.style.setProperty('--pulse-phase',`-${phase}ms`); }

    async function sampleCR(){ const day=new Intl.DateTimeFormat('en-CA',{timeZone:'America/New_York',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date()); const url=`https://api.courtreserve.com/api/v1/eventcalendar/eventlist?orgMemberId=${ORG_MEMBER_ID}&startDate=${day}T00:00:00&endDate=${day}T23:59:59`; const t0=performance.now(); const r=await fetch(url,{cache:'no-store',headers:{Authorization:AUTH_B64}}); const t2=performance.now(); const hdr=r.headers.get('Date'); const ms=hdr?parseHttpDate(hdr):null; if(ms==null) throw new Error('CR no time'); return {baseMs:ms, baseT:(t0+t2)/2, rtt:t2-t0}; }
    async function sampleWTA(){ const url='https://worldtimeapi.org/api/timezone/Etc/UTC'; const t0=performance.now(); const r=await fetch(url,{cache:'no-store'}); const t2=performance.now(); let ms=null; try{const d=await r.clone().json(); if(typeof d.unixtime==='number') ms=d.unixtime*1000;}catch(_){ } if(ms==null){ const hdr=r.headers.get('Date'); const x=hdr?parseHttpDate(hdr):null; if(x!=null) ms=x; } if(ms==null) throw new Error('WTA no time'); return {baseMs:ms, baseT:(t0+t2)/2, rtt:t2-t0}; }
    async function takeSamples(){ const a=[]; for(let i=0;i<3;i++){try{a.push(await sampleCR());}catch(e){}} for(let i=0;i<2;i++){try{a.push(await sampleWTA());}catch(e){}} if(!a.length) throw new Error('no net'); a.sort((x,y)=>x.rtt-y.rtt); const best=a.slice(0,Math.max(1,Math.ceil(a.length/2))); best.sort((x,y)=>x.baseMs-y.baseMs); return best[Math.floor(best.length/2)]; }
    async function syncTime(){ try{ const s=await takeSamples(); NET_BASE_MS=s.baseMs; NET_BASE_T=s.baseT; if(!NET_LOCKED){ NET_LOCKED=true; document.body.classList.remove('wait-net','local-fallback'); setPulsePhase(); } }catch(e){} }

    function parseTimeAny(t, baseDateLocal=null){
      if(t==null||t==="") return null;
      if(t instanceof Date) return isNaN(t.getTime())?null:t;
      if(typeof t==="number") return new Date(t>1e12?t:t*1000);
      if(typeof t==="string"){
        const s=t.trim();
        const m=s.match(/^\/Date\((\d+)\)\/$/i); if(m) return new Date(parseInt(m[1],10));
        if(/^\d{1,2}:\d{2}(\s*[AP]M)?$/i.test(s)){
          const base=baseDateLocal||new Date(); const [hhmm,ampmRaw]=s.split(/\s+/); let [hh,mm]=hhmm.split(':').map(x=>parseInt(x,10)); const ampm=ampmRaw?ampmRaw.toUpperCase():null; if(ampm){ if(ampm==='PM'&&hh<12) hh+=12; if(ampm==='AM'&&hh===12) hh=0; } return new Date(base.getFullYear(),base.getMonth(),base.getDate(),hh,mm,0,0);
        }
        const d=new Date(s); if(!isNaN(d.getTime())) return d;
      }
      return null;
    }
    function pickArray(c){ if(!c) return []; if(Array.isArray(c)) return c; if(typeof c==='object'){ const keys=['Data','data','Results','Items','Reservations','ReservationList']; for(const k of keys){ if(Array.isArray(c[k])) return c[k]; } if(c.Data && typeof c.Data==='object'){ for(const k of keys){ if(Array.isArray(c.Data[k])) return c.Data[k]; } } } return []; }

    /* SMART court matcher */
    function collectNumsFromAny(v, out){
      if(v==null) return;
      if(typeof v==='number' && Number.isFinite(v)){ out.add(v); return; }
      if(typeof v==='string'){
        const s=v.toLowerCase(); let m;
        const labeled=/(?:court|courts|crt|ct|resource|rm)\s*#?\s*(\d{1,2})(?:\s*[-–]\s*(\d{1,2}))?/gi;
        while((m=labeled.exec(s))!==null){ const a=+m[1], b=m[2]?+m[2]:null; if(b!=null){ for(let i=Math.min(a,b); i<=Math.max(a,b); i++) out.add(i);} else out.add(a); }
        const bare=/(\d{1,2})\s*[-–]\s*(\d{1,2})/g;
        while((m=bare.exec(s))!==null){ const a=+m[1], b=+m[2]; for(let i=Math.min(a,b); i<=Math.max(a,b); i++) out.add(i); }
        const listy=/(?:^|[^\d])(\d{1,2})(?=\s*(?:[,&/+]|and|\b))/g;
        while((m=listy.exec(s))!==null) out.add(+m[1]);
        return;
      }
      if(Array.isArray(v)){ v.forEach(x=>collectNumsFromAny(x,out)); return; }
      if(typeof v==='object'){
        const prefer=['Courts','AssignedCourts','EventCourts','Resources','Court','CourtId','CourtIds','CourtNumber','CourtNumbers','CourtName','CourtNames','CourtNamesCsv','CourtsText','Resource','ResourceId','ResourceIds','ResourceName'];
        prefer.forEach(k=>{ if(k in v) collectNumsFromAny(v[k],out); });
        Object.keys(v).forEach(k=>{ if(/court|resource/i.test(k)) collectNumsFromAny(v[k],out); });
        if(out.size===0){ Object.keys(v).forEach(k=>{ const val=v[k]; if(typeof val==='string') collectNumsFromAny(val,out); }); }
        return;
      }
    }
    function extractCourtNumbersDeep(rec){ const out=new Set(); collectNumsFromAny(rec,out); return Array.from(out); }
    function matchesCourtStrict(rec, n){ try{ const nums=extractCourtNumbersDeep(rec); return nums.includes(n); }catch(e){ return false; } }

    function toNY(ms){ return new Date(ms).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/New_York'}); }
    function dayNY(){ const f=new Intl.DateTimeFormat('en-CA',{timeZone:'America/New_York',year:'numeric',month:'2-digit',day:'2-digit'}); return f.format(new Date()); }

    /* ===== Countdown lock & rendering ===== */
    let countdownTimer=null, countdownTarget=null, countdownMode='none', nextStartMs=null, underMinOn=false;
    let lastGood=null, initialRendered=false;

    function setUnderMinute(on){
      const box=document.getElementById('countdown');
      if(on && !underMinOn){ box.classList.add('under-minute'); document.body.classList.add('global-under-minute'); setPulsePhase(); underMinOn=true; }
      if(!on && underMinOn){ box.classList.remove('under-minute'); document.body.classList.remove('global-under-minute'); underMinOn=false; }
    }
    function setCountdown(newTargetMs, newMode){
      if(countdownTarget===newTargetMs && countdownMode===newMode) return;
      countdownTarget=newTargetMs; countdownMode=newMode;
      if(countdownTimer) cancelAnimationFrame(countdownTimer), countdownTimer=null;
      if(!newTargetMs){ document.getElementById('cd-val').textContent='--'; setUnderMinute(false); return; }
      tickCountdown();
    }
    function tickCountdown(){
      const el=document.getElementById('cd-val');
      const diff=countdownTarget - nowMs();
      if(diff>0){
        const totalSec=Math.floor(diff/1000); const totalMin=Math.floor(diff/60000);
        if(diff<=60000){ const s=totalSec%60; el.textContent=s+'s'; setUnderMinute(true); }
        else { if(totalMin>=60){ const h=Math.floor(totalMin/60), rem=totalMin%60; el.textContent=h+'h '+rem+'m'; } else { el.textContent=totalMin+'m'; } setUnderMinute(false); }
      }else{
        setUnderMinute(false);
        if(countdownMode==='cur' && nextStartMs){ countdownMode='next'; countdownTarget=nextStartMs; document.getElementById('cd-label').textContent='Time Until'; }
        else { el.textContent='--'; countdownTarget=null; }
      }
      countdownTimer = requestAnimationFrame(tickCountdown);
    }

    function render(cur, nxt){
      const curEl=document.getElementById('cur-val'); const cdLabel=document.getElementById('cd-label'); const nextEl=document.getElementById('next-val');
      initialRendered=true;
      if(cur){
        curEl.innerHTML=`${cur.name}<div class='meta'>${toNY(cur.start.getTime())} - ${toNY(cur.end.getTime())}</div>`;
        cdLabel.textContent='Time Left';
        setCountdown(cur.end.getTime(), 'cur');
      } else {
        curEl.textContent='No current event';
        if(nxt){
          cdLabel.textContent='Time Until';
          setCountdown(nxt.start.getTime(), 'next');
        } else {
          cdLabel.textContent='Time Left';
          setCountdown(null, 'none');
        }
      }
      if(nxt){ nextEl.innerHTML=`${nxt.name}<div class='meta'>${toNY(nxt.start.getTime())} - ${toNY(nxt.end.getTime())}</div>`; }
      else { nextEl.textContent='No upcoming event'; }
    }

    function failSafeFirstFrame(){
      if(!initialRendered){ render(null, null); }
    }

    function fetchWithTimeout(url, opts={}, timeoutMs=6000){
      const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(), timeoutMs);
      return fetch(url, {...opts, signal: ctrl.signal}).finally(()=>clearTimeout(id));
    }

    async function refresh(){
      const d=dayNY();
      const evUrl=`https://api.courtreserve.com/api/v1/eventcalendar/eventlist?orgMemberId=${ORG_MEMBER_ID}&startDate=${d}T00:00:00&endDate=${d}T23:59:59`;
      const resUrl=`https://api.courtreserve.com/api/v1/reservationreport/listactive?reservationsFromDate=${d}&reservationsToDate=${d}`;

      try{
        const [eRes, rRes] = await Promise.allSettled([
          fetchWithTimeout(evUrl, {headers:{Authorization:AUTH_B64}}).then(r=>r.ok?r.json():Promise.reject(new Error('ev '+r.status))),
          fetchWithTimeout(resUrl,{headers:{Authorization:AUTH_B64}}).then(r=>r.ok?r.json():Promise.reject(new Error('res '+r.status)))
        ]);

        const eArr = eRes.status==='fulfilled' ? pickArray(eRes.value) : [];
        const rArr = rRes.status==='fulfilled' ? pickArray(rRes.value) : [];
        if(eRes.status==='fulfilled' || rRes.status==='fulfilled'){ lastNetOKPerf = performance.now(); }

        if(eArr.length===0 && rArr.length===0 && lastGood){ render(lastGood.cur, lastGood.nxt); return; }

        const baseDateLocal=new Date();
        const events=eArr.map(x=>({ source:'event', raw:x, name:x.EventName||x.Name||'Event', start:parseTimeAny(x.StartDateTime||x.StartTime||x.Start, baseDateLocal), end:parseTimeAny(x.EndDateTime||x.EndTime||x.End, baseDateLocal) })).filter(it=>it.start&&it.end&&matchesCourtStrict(it.raw, COURT_NO));
        const reservations=rArr.map(x=>{
          const start=parseTimeAny(x.StartTime||x.StartDateTime||x.Start, baseDateLocal);
          const end  =parseTimeAny(x.EndTime||x.EndDateTime||x.End,   baseDateLocal);
          const players=Array.isArray(x.Players)?x.Players:[];
          const pn=players.map(p=>{ const fn=(p.FirstName||'').trim(), ln=(p.LastName||'').trim(); return fn&&ln?`${fn} ${(ln[0]||'')}.`:(fn+' '+ln).trim(); }).filter(Boolean);
          const nm= pn.length? pn.join(', ') :
            (function(){ const fields=['MemberDisplayName','OrganizerName','Organizer','MemberName','MemberFullName','OwnerName','BookedByName','BookerName','CreatedByName','ReservationOwnerName','PrimaryMemberName','CreatedBy','DisplayName','ReservationName','Title','Description','Notes','PlayersText','CreatedByDisplayName']; for(const k of fields){ if(x[k] && String(x[k]).trim()) return String(x[k]).trim(); } if(x.ReservationTypeName&&x.ReservationTypeName.trim()) return x.ReservationTypeName.trim(); return 'Reserved'; })();
          return { source:'reservation', raw:x, name:nm, start, end };
        }).filter(it=>it.start&&it.end&&matchesCourtStrict(it.raw, COURT_NO));

        const forCourt=reservations.concat(events).sort((a,b)=> a.start - b.start);
        const nowSynced=new Date(nowMs());
        let cur=null, nxt=null;
        for(const item of forCourt){
          if(!cur && nowSynced>=item.start && nowSynced<=item.end) cur=item;
          if(!nxt && nowSynced<item.start) nxt=item;
        }
        nextStartMs = nxt ? nxt.start.getTime() : null;

        render(cur, nxt);
        lastGood = {cur, nxt, t: Date.now()};
      }catch(e){
        if(lastGood){ render(lastGood.cur, lastGood.nxt); }
        else { render(null, null); }
      }
    }

    function tickClock(){ const el=document.getElementById('clock'); el.textContent=new Date(nowMs()).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/New_York'}); const ms=1000-(performance.now()%1000); setTimeout(tickClock, Math.max(250,ms)); }

    /* ===== Keep the network warm & recover fast ===== */
    function keepAlivePing(){ fetch(KEEPALIVE_URL, {mode:'no-cors', cache:'no-store'}).catch(()=>{}); }
    function watchdog(){
      const now = performance.now();
      if(now - lastNetOKPerf > WATCHDOG_MS){
        // Proactively re-sync and refresh; this prevents silent "stall" while Wi‑Fi is still up.
        keepAlivePing();
        syncTime();
        refresh();
      }
    }

    function init(){
      // Graceful visual fallback if net time not locked quickly
      setTimeout(()=>{ if(!NET_LOCKED){ document.body.classList.remove('wait-net'); document.body.classList.add('local-fallback'); } }, NET_GRACE_MS);

      // First draws
      refresh();
      setInterval(refresh, 30000);
      setTimeout(failSafeFirstFrame, 7000);

      // Time sync loop
      (function schedule(){ const elapsed=performance.now()-startPerf; syncTime(); setTimeout(schedule, elapsed<BURST_WINDOW_MS?BURST_INTERVAL_MS:RESYNC_MS); })();

      // Clock tick
      tickClock();

      // Connectivity aides
      keepAlivePing();
      setInterval(keepAlivePing, KEEPALIVE_MS);
      setInterval(watchdog, 10000);

      // React instantly to browser connectivity changes
      window.addEventListener('online', ()=>{ document.body.classList.remove('offline'); keepAlivePing(); syncTime(); refresh(); });
      window.addEventListener('offline', ()=>{ document.body.classList.add('offline'); });
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
